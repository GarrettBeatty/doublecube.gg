name: Test Claude Changes

on:
  pull_request:
    branches: [ main ]
  push:
    branches: 
      - 'claude/**'  # Auto-run on Claude branches

jobs:
  test: 
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup . NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build
        run: dotnet build

      - name: Test
        run: dotnet test --verbosity normal

      - name: Comment Result
        if: always()
        uses: actions/github-script@v7
        with: 
          script: |
            const status = '${{ job.status }}' === 'success' ? '✅ Tests passed' : '❌ Tests failed';
            
            let issueNumber;
            
            // For pull_request events, use context.issue.number
            if (context.eventName === 'pull_request') {
              issueNumber = context.issue.number;
            } 
            // For push events, parse from branch name pattern:  issue-34-20260101-1531
            else if (context.eventName === 'push') {
              const branch = context. ref.replace('refs/heads/', '');
              const match = branch.match(/^issue-(\d+)/);
              if (match) {
                issueNumber = parseInt(match[1]);
              }
            }
            
            if (issueNumber) {
              await github.rest.issues. createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: status
              });
            } else {
              console.log('No issue number found - skipping comment');
            }
