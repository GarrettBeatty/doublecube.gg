backgammon.beatty.codes, doublecube.gg {
    # Client configuration endpoint (served by WebClient for service discovery)
    handle /api/config {
        reverse_proxy webclient:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Server API endpoints
    handle /api/* {
        reverse_proxy server:5000
    }

    # SignalR WebSocket endpoint
    handle /gamehub* {
        reverse_proxy server:5000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}

            # WebSocket upgrade headers (critical for SignalR)
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}

            # Force HTTP/1.1 for WebSocket support
            transport http {
                versions 1.1
                read_timeout 5m
                write_timeout 5m
            }

            # Disable buffering for SSE/WebSocket keepalive
            flush_interval -1
        }
    }

    # Health check endpoints
    handle /health {
        reverse_proxy server:5000
    }

    handle /alive {
        reverse_proxy server:5000
    }

    handle /stats {
        reverse_proxy server:5000
    }

    # WebClient - Serve static content (catch-all, must be last)
    handle /* {
        reverse_proxy webclient:3000
    }

    # Enable automatic HTTPS
    tls {$TLS_EMAIL:admin@example.com}

    # Enable access logging
    log {
        output stdout
        format console
    }
}
